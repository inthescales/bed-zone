<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Bedzone</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <script src="/phaser.js"></script>
		<script src="/jquery-1.11.2.min.js"></script>
        <script src="/tracery.min.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {
    
        var canvas_width = 800;
        var canvas_height = 600;
        var protagonist_size = 24;
        var protagonist_scale = 4;

        var game = new Phaser.Game(canvas_width, canvas_height, Phaser.CANVAS, '', { preload: preload, create: create, update: update, render: render});
        var graphics;
        var layer;
        var cursors;
        
        var protagonist;
        
        var alice_text = [];
        var alice_text_obj = [];
        var alice_scroll = 0;
        var alice_started = -1;
        var alice_done = -1;
        var eyes_text = "You can't focus your eyes..."
        var eyes_text_obj = null;
        
        var whale_sound = null;
        var dream = [];
        var dream_scroll = 0;
        var dream_count = 3;
        var wake_color = "#038ac4";
        var sleep_color = "#073870";
        
        var chat_obj = [];
        var chat_name = [];
        var chat_text = [];
        var chat_buffer = [];
        var chat_timer = null;
        var chat_lines = 8;
        var chat_grammar = {
            "convo": ["#start##topic#"],
            "start": ["#greeting#\n#greeting#\n#starter#\n"],
            "greeting": ["Hey#!#", "Hi#!#", "Hello#!#"],
            "starter": ["#howzit#\n#good#", "#sup#\n#nothing_sup#"],
            "sup": ["What's up?", "sup?", "What's goin on?"],
            "howzit": ["How's it going?", "How are you", "How are you doing", "How ya doin"],
            "good": ["Pretty good", "Fine", "Not bad", "Not too bad", "Decent"],
            "nothing_sup": ["nothing", "not much", "not too much", "eh", "same as always"],
            
            "topic": ["#did_you_go#\n#affirmative#\n#how_was_event#\n#review#\n#event_react#\n#event_detail#", "#did_you_go#\n#did_go#\n#event_react#\n#event_detail#", "#did_you_go#\n#did_not_go#\n#understood#", "#did_you_go#\n#did_not_go#\n#understood#"],
            "did_you_go": ["#start_tag#did you go to #event#?", "#start_tag#did you end up going to #event#?"],
            "event": ["that #event_type#", "#name#'s #event_type#"],
            "event_type": ["movie", "show", "party", "thing", "event", "performance", "reading", "lecture", "whatever it was", "orgy"],
            "did_not_go": ["#negative#, #excuse#"],
            "did_go": ["#affirmative#, #review#"],
            "negative": ["no", "nah", "nope"],
            "excuse": ["I was too busy", "I had to work", "I was tired", "I wasn't feeling well", "I was sick", "I got distracted", "my family was in town", "I was out of town", "I slept through it", "I forgot"],
            "affirmative": ["yeah", "yes"],
            "how_was_event": ["how was it?", "was it good?", "how'd it go?", "did you have a good time?"],
            "review": ["#neg_review#", "#pos_review#"],
            "neg_review": ["It was #neg_event#", "#neg_event# as hell"],
            "neg_event": ["boring", "lame", "a snooze", "terrible", "horrible", "dull"],
            "pos_review": ["It was #pos_event#"],
            "pos_event": ["fun", "super fun", "great", "awesome", "a blast", "pretty good", "nice"],
            "event_react": ["#understood#", "#event_reflect#"],
            "event_reflect": ["", "wish I'd gone", "sorry I missed it\n#forgive#", "I wonder if there'll be another one\n#unknown#", "maybe I'll go next time"],
            "event_detail": ["#name# was there\n#name_react#", "#figure# was there\n#excited#"],
            "name_react": ["#approve#", "#disapprove#", "#disapprove#\n#forgive#"],
            
            "start_tag": ["hey, ", "so, ", "", ""],
            "understood": ["ah", "I see", "gotcha", "mhm"],
            "approve": ["nice", "cool", "rad", "awesome", "neat", "sweet"],
            "excited": ["Oh!!!", "~swoon~", "ahhhhhhh!", "OMG", "Really?????"],
            "disapprove": ["that sucks", "lame", "aww", "shame"],
            "forgive": ["it's ok", "it's fine", "don't worry about it", "whatever", "it's cool", "it's no problem"],
            "unknown": ["I don't know", "maybe", "who knows", "couldn't say", "I'm not sure", "it's possible", "could be"],
            "name": ["Jack", "Jeremy", "Tom", "Harlan", "Mack", "Forrest", "Fran", "Kate", "Erin", "Phoenix", "Zoe", "Rain", "Chloe", "Brent", "Jamaal", "Tariq", "Cynthia", "Pip", "Zip", "Bud", "Marten"],
            "figure": ["that #person_type# you like", "that #person_type# from #name#'s #event_type#", "that #person_type# from your #event_type#", "that #person_type# um...\n#name#?\n#affirmative#\n"],
            "person_type": ["guy", "girl"],
            "laugh": ["hehe", "hehehe", "haha", "hahaha", "heh", "lol", "lolol", "lmao", "rofl"],
            "!": ["!", ""]
        };
        var grammar_obj = null;
        
        var current_mode = "";
        
        function preload () {
        
            game.scale.pageAlignHorizontally = true;
            
            game.load.spritesheet('sleep', 'assets/sleep.png', protagonist_size, protagonist_size);
            game.load.spritesheet('read', 'assets/read.png', protagonist_size, protagonist_size);
            game.load.spritesheet('chat', 'assets/chat.png', protagonist_size, protagonist_size);
            game.load.spritesheet('eat', 'assets/eat.png', protagonist_size, protagonist_size);
            game.load.spritesheet('lie', 'assets/lie.png', protagonist_size, protagonist_size);
            
            game.load.audio('whale', 'whales_modified.ogg');
            game.load.image('dream_1', 'assets/dream_1.png');
            game.load.image('dream_2', 'assets/dream_2.png');
            game.load.image('dream_3', 'assets/dream_3.png');
            whale_sound = new Phaser.Sound(game, 'whale', 1, true);
            
            game.time.advancedTiming = true;
            
            get_alice();
        }

        function create() {

            protagonist = game.add.sprite((canvas_width / 2) - (protagonist_size * protagonist_scale / 2), (canvas_height / 2) - (protagonist_size * protagonist_scale / 2));
            protagonist.scale.set(protagonist_scale);
            protagonist.smoothed = false;
            
            game.stage.backgroundColor = wake_color;
            
            set_mode("lie");            
            
            // Key presses
            cursors = game.input.keyboard.createCursorKeys();
            var upKey = game.input.keyboard.addKey(Phaser.Keyboard.UP);
            var downKey = game.input.keyboard.addKey(Phaser.Keyboard.DOWN);
            var rightKey = game.input.keyboard.addKey(Phaser.Keyboard.RIGHT);
            var leftKey = game.input.keyboard.addKey(Phaser.Keyboard.LEFT);
            upKey.onDown.add(upKeyPressed, this);
            upKey.onUp.add(keyReleased, this);
            downKey.onDown.add(downKeyPressed, this);
            downKey.onUp.add(keyReleased, this);
            rightKey.onDown.add(rightKeyPressed, this);
            rightKey.onUp.add(keyReleased, this);
            leftKey.onDown.add(leftKeyPressed, this);
            leftKey.onUp.add(keyReleased, this);
        }
        
        function update() {
 
            if (current_mode == "read") {

                for (var j = 0; j < 3; j++) {
                
                    var excess = 0;
                    
                    for (var k = 0; k < j; k++) {
                        excess += alice_text_obj[k].height;
                    }                    
                
                    if (alice_done < j && alice_text_obj[j].height + alice_text_obj[j].y + excess + canvas_height <= -32) {
                        alice_done = j;
                    }
                
                    if (alice_started < j && alice_text_obj[j].y + excess <= canvas_height + 16) {
                        alice_started = j;
                    }
                }
            
                for (var j = 0; j < 3; j++) {
                
                    if (alice_started >= j && alice_done < j) {
                        if (alice_text_obj[j].alpha <= 0) {
                            game.add.tween(alice_text_obj[j]).to( { alpha: 1 }, 2000, Phaser.Easing.Linear.None, true, 0, 0, false);
                        }
                    }
                    else {
                        if (alice_text_obj[j].alpha > 0) {
                            game.add.tween(alice_text_obj[j]).to( { alpha: 0 }, 2000, Phaser.Easing.Linear.None, true, 0, 0, false);
                        }
                    }
                }
            
                if (alice_done >= 2) {
                    
                    if (eyes_text_obj.alpha == 0) {
                        game.add.tween(eyes_text_obj).to( { alpha: 1 }, 2000, Phaser.Easing.Linear.None, true, 0, 0, false);
                    }
                } else {
                
                    var scroll_amount = 0.25;
                    if (game.time.fps > 0) {
                        scroll_amount = (60 / game.time.fps) * 0.25;
                    }
                    
                    alice_scroll += scroll_amount;
                    
                    for (var j = 0; j < 3; j++) {
                        alice_text_obj[j].y = -alice_scroll;
                    }
                }
            }
            else if (current_mode == "sleep") {

                var scroll_amount = 0.3;
                //if (game.time.fps > 0) {
                //    scroll_amount = (60 / game.time.fps) * 0.25;
                //}
                                
                for (var j = 0; j < 3; j++) {
                    dream[j].y -= scroll_amount;
                    if (dream[j].y <= -canvas_height) {
                        dream[j].y = canvas_height * 2;
                    }
                }
            } else if (current_mode == "chat") {
            
                
            
            }
        
        }
        
        function render() {
        
            game.debug.text(game.time.fps, 10, 10, "#ffffff");
            //game.debug.text(alice_started, 10, 25, "#ffffff");
            //game.debug.text(alice_done, 10, 40, "#ffffff");
        }
        
        function get_alice() {
        
            var rawFile = [0, 0, 0];
            for (var n = 1; n < 4; n++) {
                
                rawFile[n-1] = new XMLHttpRequest();
                rawFile[n-1].open("GET", "carroll-alice_" + n + ".txt", true);
                rawFile[n-1].n = n;
                rawFile[n-1].onreadystatechange = function ()
                {
                    if(this.readyState === 4) {
                    
                        if(this.status === 200 || this.status == 0)
                        {
                            var allText = this.responseText;
                            //alert(allText);
                            alice_text[this.n-1] = allText;
                        }
                    }
                }
                
                rawFile[n-1].send(null);
            }
        }
        
        function get_chat(num) {
        
            var grammar_obj = tracery.createGrammar(chat_grammar);
            var trace = grammar_obj.flatten("#convo#");
            var split = trace.split("\n");
            return split;
        }
        
        function keyReleased() {
            set_mode("lie");
        }
        
        function upKeyPressed() {
            set_mode("sleep")
        }
        
        function downKeyPressed() {
            set_mode("chat");
        }
        
        function rightKeyPressed() {
            set_mode("read");
        }
        
        function leftKeyPressed() {
            set_mode("eat");
        }
        
        function set_mode(new_mode) {
        
            var key = new_mode;
            var anim = null;
            var speed = 0;
        
            if (new_mode == current_mode) {
                return;
            }
        
            if (new_mode == "sleep") {
            
                speed = 5;
                start_sleeping();
            }
            else if (new_mode == "read") {
            
                speed = 5;
                start_reading();
            }
            else if (new_mode == "eat") {
            
                speed = 5;
            
            }
            else if (new_mode == "chat") {
            
                speed = 5;
                start_chatting();
            }
            else if (new_mode == "lie") {
            
                speed = 5;
            }
            
            if (key == null) return;
            
            protagonist.loadTexture(key);
            protagonist.animations.add(key);
            protagonist.animations.play(key, speed, true);
            
            leave_mode(current_mode);
            current_mode = key;
        
        }
        
        function leave_mode(old_mode) {
            
            if (old_mode == "read") {
                for (var j = 0; j < 3; j++) {
                    game.add.tween(alice_text_obj[j]).to( { alpha: 0 }, 2000, Phaser.Easing.Linear.None, true, 0, 0, false);
                }
                
                if (eyes_text_obj.alpha > 0) {
                    game.add.tween(eyes_text_obj).to( { alpha: 0 }, 2000, Phaser.Easing.Linear.None, true, 0, 0, false);
                }
            }
            else if (old_mode == "sleep") {
            
                whale_sound.pause();
                for (var j = 0; j < 3; j++) {    
                    dream[j].alpha = 0;
                }
                game.stage.backgroundColor = wake_color;
            }
            else if (old_mode == "chat") {
            
                for (var j = 0; j < 3; j++) {
                    chat_obj[j].alpha = 0;
                }
                clearInterval(chat_timer);
            }
        }
        
        function start_reading() {

            var style = { font: "16px Arial", fill: "#fff", align: "left", boundsAlignH: "left", boundsAlignV: "top", wordWrap: true, wordWrapWidth: canvas_width - 32 };
            var center_style = { font: "16px Arial", fill: "#fff", align: "center", boundsAlignH: "left", boundsAlignV: "top", wordWrap: true, wordWrapWidth: canvas_width - 32 };

            if (alice_text_obj[0] == null) {
            
                alice_text_obj[0] = game.add.text(0, 0, alice_text[0], style);
                var buffer = canvas_width - alice_text_obj[0].width;
                alice_text_obj[0].setTextBounds(buffer / 2, canvas_height, canvas_width - buffer);
                alice_text_obj[0].alpha = 0;
                
                alice_text_obj[1] = game.add.text(0, 0, alice_text[1], style);
                alice_text_obj[1].setTextBounds(buffer / 2, canvas_height + alice_text_obj[0].height, canvas_width - buffer);
                alice_text_obj[1].alpha = 0;
                
                alice_text_obj[2] = game.add.text(0, 0, alice_text[2], style);
                alice_text_obj[2].setTextBounds(buffer / 2, canvas_height + alice_text_obj[0].height + alice_text_obj[1].height, canvas_width - buffer);
                alice_text_obj[2].alpha = 0;
                
                eyes_text_obj = game.add.text(0, 0, eyes_text, center_style);
                var eyes_buffer = canvas_width - eyes_text_obj.width;
                eyes_text_obj.setTextBounds(eyes_buffer / 2, canvas_height / 4)
                eyes_text_obj.alpha = 0;
            }
            
            for (var j = 0; j < 3; j++) {
                if (alice_started >= j && alice_done < j) {
                    game.add.tween(alice_text_obj[j]).to( { alpha: 1 }, 2000, Phaser.Easing.Linear.None, true, 0, 0, false);
                }
            }
            
            if (alice_done >= 3 && eyes_text_obj.alpha == 0) {
                game.add.tween(eyes_text_obj).to( { alpha: 1 }, 2000, Phaser.Easing.Linear.None, true, 0, 0, false);
            }
        }
        
        function start_sleeping() {
        
            whale_sound.play();
            
            if (dream[0] == null) {
            
                for (var j = 0; j < 3; j++) {
                    dream[j] = game.add.sprite(200, canvas_height * (j + 1));
                    dream[j].scale.set(protagonist_scale);
                    dream[j].smoothed = false;
                }
                
                dream[0].loadTexture('dream_3');
                dream[1].loadTexture('dream_1');
                dream[2].loadTexture('dream_2');
            }
            
            for (var j = 0; j < 3; j++) {
                dream[j].y = canvas_height * (j + 1) + 100;
                dream[j].alpha = 1;
            }
            
            game.stage.backgroundColor = sleep_color;
        }
        
        function start_chatting() {
        
            var style = { font: "16px Arial", fill: "#fff", align: "left", boundsAlignH: "left", boundsAlignV: "top", wordWrap: true, wordWrapWidth: canvas_width - 32 };
            if (chat_obj[0] == null) {
            
                for (var j = 0; j < 3; j++) {
                
                    chat_text[j] = [];
                    
                    chat_obj[j] = game.add.text(0, 0, "", style);
                    chat_obj[j].setTextBounds((canvas_width / 3) * j + 20, 20 , (canvas_width / 3) - 40, canvas_height - 20);
                    
                    chat_buffer[j] = get_chat(j);
                }
            
                chat_name[0] = "date";
                chat_name[1] = "bro";
                chat_name[2] = "them";
            
            }
            
            for (var j = 0; j < 1; j++) {
                chat_obj[j].alpha = 1;
            }
            
            chat_happens();
            chat_timer = setInterval(chat_happens, 2000);
        
        }
        
        // ETC ---------------------
        
        function chat_happens() {
        
            var j = Math.floor((Math.random() * 3));
            
            var line = chat_buffer[j][0];
            chat_text[j].push(line);
            
            var displayText = display_text_for(chat_text[j], "You", chat_name[j]);
            
            chat_obj[j].setText(displayText);
            chat_buffer[j] = chat_buffer[j].slice(1, chat_buffer[j].length);
            
            if (chat_buffer[j].length == 0) {
                chat_buffer[j] = get_chat(j);
            }
            
            if (chat_text[j].length > chat_lines) {
                chat_text[j] = chat_text[j].slice(1, chat_text[j].length);
            }
        }
        
        function display_text_for(text, name1, name2) {
        
            var ret = "";
            
            for (var i = 0; i < text.length; i++) {
            
                if (i%2 == 0) {
                    ret += name1;
                } else {
                    ret += name2;
                }
                
                ret += ": " + text[i] + "\n";
            }
            
            return ret;
        }
    }
    
    </script>

    </body>
</html>