<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Bedzone</title>
        <link rel="stylesheet" type="text/css" href="style.css">
        <script src="/phaser.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {
    
        var canvas_width = 800;
        var canvas_height = 600;
        var protagonist_size = 24;
        var protagonist_scale = 4;

        var game = new Phaser.Game(canvas_width, canvas_height, Phaser.CANVAS, '', { preload: preload, create: create, update: update, render: render});
        var graphics;
        var layer;
        var cursors;
        
        var protagonist;
        
        var alice_text = [];
        var alice_text_obj = [];
        var alice_scroll = 0;
        var alice_started = -1;
        var alice_done = -1;
        var eyes_text = "You can't focus your eyes..."
        var eyes_text_obj = null;
        
        var whale_sound = null;
        var dream = [];
        var dream_scroll = 0;
        var dream_count = 3;
        var wake_color = "#038ac4";
        var sleep_color = "#073870";
        
        var current_mode = "";
        
        function preload () {
        
            game.scale.pageAlignHorizontally = true;
            
            game.load.spritesheet('sleep', 'assets/sleep.png', protagonist_size, protagonist_size);
            game.load.spritesheet('read', 'assets/read.png', protagonist_size, protagonist_size);
            game.load.spritesheet('chat', 'assets/chat.png', protagonist_size, protagonist_size);
            game.load.spritesheet('eat', 'assets/eat.png', protagonist_size, protagonist_size);
            game.load.spritesheet('lie', 'assets/lie.png', protagonist_size, protagonist_size);
            
            game.load.audio('whale', 'whales_modified.ogg');
            game.load.image('dream_1', 'assets/dream_1.png');
            game.load.image('dream_2', 'assets/dream_2.png');
            game.load.image('dream_3', 'assets/dream_3.png');
            whale_sound = new Phaser.Sound(game, 'whale', 1, true);
            
            game.time.advancedTiming = true;
            
            get_alice();
        }

        function create() {

            protagonist = game.add.sprite((canvas_width / 2) - (protagonist_size * protagonist_scale / 2), (canvas_height / 2) - (protagonist_size * protagonist_scale / 2));
            protagonist.scale.set(protagonist_scale);
            protagonist.smoothed = false;
            
            game.stage.backgroundColor = wake_color;
            
            set_mode("lie");            
            
            // Key presses
            cursors = game.input.keyboard.createCursorKeys();
            var upKey = game.input.keyboard.addKey(Phaser.Keyboard.UP);
            var downKey = game.input.keyboard.addKey(Phaser.Keyboard.DOWN);
            var rightKey = game.input.keyboard.addKey(Phaser.Keyboard.RIGHT);
            var leftKey = game.input.keyboard.addKey(Phaser.Keyboard.LEFT);
            upKey.onDown.add(upKeyPressed, this);
            upKey.onUp.add(keyReleased, this);
            downKey.onDown.add(downKeyPressed, this);
            downKey.onUp.add(keyReleased, this);
            rightKey.onDown.add(rightKeyPressed, this);
            rightKey.onUp.add(keyReleased, this);
            leftKey.onDown.add(leftKeyPressed, this);
            leftKey.onUp.add(keyReleased, this);
        }
        
        function update() {
 
            if (current_mode == "read") {

                for (var j = 0; j < 3; j++) {
                
                    var excess = 0;
                    
                    for (var k = 0; k < j; k++) {
                        excess += alice_text_obj[k].height;
                    }                    
                
                    if (alice_done < j && alice_text_obj[j].height + alice_text_obj[j].y + excess + canvas_height <= -32) {
                        alice_done = j;
                    }
                
                    if (alice_started < j && alice_text_obj[j].y + excess <= canvas_height + 16) {
                        alice_started = j;
                    }
                }
            
                for (var j = 0; j < 3; j++) {
                
                    if (alice_started >= j && alice_done < j) {
                        if (alice_text_obj[j].alpha <= 0) {
                            game.add.tween(alice_text_obj[j]).to( { alpha: 1 }, 2000, Phaser.Easing.Linear.None, true, 0, 0, false);
                        }
                    }
                    else {
                        if (alice_text_obj[j].alpha > 0) {
                            game.add.tween(alice_text_obj[j]).to( { alpha: 0 }, 2000, Phaser.Easing.Linear.None, true, 0, 0, false);
                        }
                    }
                }
            
                if (alice_done >= 2) {
                    
                    if (eyes_text_obj.alpha == 0) {
                        game.add.tween(eyes_text_obj).to( { alpha: 1 }, 2000, Phaser.Easing.Linear.None, true, 0, 0, false);
                    }
                } else {
                
                    var scroll_amount = 0.25;
                    if (game.time.fps > 0) {
                        scroll_amount = (60 / game.time.fps) * 0.25;
                    }
                    
                    alice_scroll += scroll_amount;
                    
                    for (var j = 0; j < 3; j++) {
                        alice_text_obj[j].y = -alice_scroll;
                    }
                }
            }
            else if (current_mode == "sleep") {

                var scroll_amount = 0.5;
                //if (game.time.fps > 0) {
                //    scroll_amount = (60 / game.time.fps) * 0.25;
                //}
                                
                for (var j = 0; j < 3; j++) {
                    dream[j].y -= scroll_amount;
                    if (dream[j].y <= -canvas_height) {
                        dream[j].y = canvas_height * 2;
                    }
                }
            }
        
        }
        
        function render() {
        
            game.debug.text(game.time.fps, 10, 10, "#ffffff");
            game.debug.text(alice_started, 10, 25, "#ffffff");
            game.debug.text(alice_done, 10, 40, "#ffffff");
        }
        
        function get_alice() {
        
            var rawFile = [0, 0, 0];
            for (var n = 1; n < 4; n++) {
                
                rawFile[n-1] = new XMLHttpRequest();
                rawFile[n-1].open("GET", "carroll-alice_" + n + ".txt", true);
                rawFile[n-1].n = n;
                rawFile[n-1].onreadystatechange = function ()
                {
                    if(this.readyState === 4) {
                    
                        if(this.status === 200 || this.status == 0)
                        {
                            var allText = this.responseText;
                            //alert(allText);
                            alice_text[this.n-1] = allText;
                        }
                    }
                }
                
                rawFile[n-1].send(null);
            }
        }
        
        function keyReleased() {
            set_mode("lie");
        }
        
        function upKeyPressed() {
            set_mode("sleep")
        }
        
        function downKeyPressed() {
            set_mode("chat");
        }
        
        function rightKeyPressed() {
            set_mode("read");
        }
        
        function leftKeyPressed() {
            set_mode("eat");
        }
        
        function set_mode(new_mode) {
        
            var key = new_mode;
            var anim = null;
            var speed = 0;
        
            if (new_mode == current_mode) {
                return;
            }
        
            if (new_mode == "sleep") {
            
                speed = 5;
                start_sleeping();
            }
            else if (new_mode == "read") {
            
                speed = 5;
                start_reading();
            }
            else if (new_mode == "eat") {
            
                speed = 5;
            
            } else if (new_mode == "chat") {
            
                speed = 5;
            } else if (new_mode == "lie") {
            
                speed = 5;
            }
            
            if (key == null) return;
            
            protagonist.loadTexture(key);
            protagonist.animations.add(key);
            protagonist.animations.play(key, speed, true);
            
            leave_mode(current_mode);
            current_mode = key;
        
        }
        
        function leave_mode(old_mode) {
            
            if (old_mode == "read") {
                for (var j = 0; j < 3; j++) {
                    game.add.tween(alice_text_obj[j]).to( { alpha: 0 }, 2000, Phaser.Easing.Linear.None, true, 0, 0, false);
                }
                
                if (eyes_text_obj.alpha > 0) {
                    game.add.tween(eyes_text_obj).to( { alpha: 0 }, 2000, Phaser.Easing.Linear.None, true, 0, 0, false);
                }
            }
            else if (old_mode == "sleep") {
            
                whale_sound.pause();
                for (var j = 0; j < 3; j++) {    
                    dream[j].alpha = 0;
                }
                game.stage.backgroundColor = wake_color;
            }
        }
        
        function start_reading() {

            var style = { font: "16px Arial", fill: "#fff", align: "left", boundsAlignH: "left", boundsAlignV: "top", wordWrap: true, wordWrapWidth: canvas_width - 32 };
            var center_style = { font: "16px Arial", fill: "#fff", align: "center", boundsAlignH: "left", boundsAlignV: "top", wordWrap: true, wordWrapWidth: canvas_width - 32 };

            if (alice_text_obj[0] == null) {
            
                alice_text_obj[0] = game.add.text(0, 0, alice_text[0], style);
                var buffer = canvas_width - alice_text_obj[0].width;
                alice_text_obj[0].setTextBounds(buffer / 2, canvas_height, canvas_width - buffer);
                alice_text_obj[0].alpha = 0;
                
                alice_text_obj[1] = game.add.text(0, 0, alice_text[1], style);
                alice_text_obj[1].setTextBounds(buffer / 2, canvas_height + alice_text_obj[0].height, canvas_width - buffer);
                alice_text_obj[1].alpha = 0;
                
                alice_text_obj[2] = game.add.text(0, 0, alice_text[2], style);
                alice_text_obj[2].setTextBounds(buffer / 2, canvas_height + alice_text_obj[0].height + alice_text_obj[1].height, canvas_width - buffer);
                alice_text_obj[2].alpha = 0;
                
                eyes_text_obj = game.add.text(0, 0, eyes_text, center_style);
                var eyes_buffer = canvas_width - eyes_text_obj.width;
                eyes_text_obj.setTextBounds(eyes_buffer / 2, canvas_height / 4)
                eyes_text_obj.alpha = 0;
            }
            
            for (var j = 0; j < 3; j++) {
                if (alice_started >= j && alice_done < j) {
                    game.add.tween(alice_text_obj[j]).to( { alpha: 1 }, 2000, Phaser.Easing.Linear.None, true, 0, 0, false);
                }
            }
            
            if (alice_done >= 3 && eyes_text_obj.alpha == 0) {
                game.add.tween(eyes_text_obj).to( { alpha: 1 }, 2000, Phaser.Easing.Linear.None, true, 0, 0, false);
            }
        }
        
        function start_sleeping() {
        
            whale_sound.play();
            
            if (dream[0] == null) {
            
                for (var j = 0; j < 3; j++) {
                    dream[j] = game.add.sprite(200, canvas_height * (j + 1));
                    dream[j].scale.set(protagonist_scale);
                    dream[j].smoothed = false;
                }
                
                dream[0].loadTexture('dream_3');
                dream[1].loadTexture('dream_1');
                dream[2].loadTexture('dream_2');
            }
            
            for (var j = 0; j < 3; j++) {
                dream[j].y = canvas_height * (j + 1) + 300;
                dream[j].alpha = 1;
            }
            
            game.stage.backgroundColor = sleep_color;
        
        }
    }
    
    </script>

    </body>
</html>